(window.webpackJsonp=window.webpackJsonp||[]).push([[0],{112:function(t,e,a){t.exports=a(166)},133:function(t,e,a){},135:function(t,e,a){},139:function(t,e){t.exports={EARTH_RADIUS:6371e3,convertDegreesToRadians:function(t){return t*Math.PI/180},convertRadiansToDegrees:function(t){return 180*t/Math.PI},computeBearings:function(t,e,a,n){var o=Math.sin(n-e)*Math.cos(a),r=Math.cos(t)*Math.sin(a)-Math.sin(t)*Math.cos(a)*Math.cos(n-e),i=Math.atan2(o,r);return(this.convertRadiansToDegrees(i)+180)%360},calculateDestinationPoint:function(t,e,a,n){var o=this.convertDegreesToRadians(t),r=this.convertDegreesToRadians(e),i=n/this.EARTH_RADIUS,s=this.convertDegreesToRadians(a),c=Math.asin(Math.sin(o)*Math.cos(i)+Math.cos(o)*Math.sin(i)*Math.cos(s)),l=this.convertRadiansToDegrees(c),u=Math.sin(s)*Math.sin(i)*Math.cos(o),p=Math.cos(i)-Math.sin(o)*Math.sin(c),h=r+Math.atan2(u,p);return{lat:l,long:(this.convertRadiansToDegrees(h)+540)%360-180}},calculateDistance:function(t,e,a,n){var o=this.convertDegreesToRadians(a-t),r=this.convertDegreesToRadians(n-e),i=this.convertDegreesToRadians(t),s=this.convertDegreesToRadians(a),c=Math.pow(Math.sin(o/2),2)+Math.pow(Math.sin(r/2),2)*Math.cos(i)*Math.cos(s),l=2*Math.atan2(Math.sqrt(c),Math.sqrt(1-c));return this.EARTH_RADIUS*l}}},141:function(t,e,a){},143:function(t,e,a){},164:function(t,e,a){},166:function(t,e,a){"use strict";a.r(e);var n=a(6),o=a.n(n),r=a(91),i=a.n(r),s=a(57),c=a.n(s),l=a(70),u=a(38),p=a(41),h=a(42),m=a(51),d=a(50),v=a(52),f=a(72),g=(a(131),a(133),a(135),a(137),a(13)),y=a(167),w=a(171),b=a(170),D=a(172),L=a(102),E=a(87),N=a(86),O=a(55),I=a(66),S=a(71),M=a(139);function j(t,e,a,n){for(var o=function(t,e,a){for(var n=0,o=e;o<a;o++){var r=t[o],i=t[o+1],s=r.lat,c=r.long,l=i.lat,u=i.long;n+=M.calculateDistance(s,c,l,u)}return n}(t,e,a)*n,r=e;r<a;){var i=t[r],s=t[r+1],c=i.lat,l=i.long,u=s.lat,p=s.long,h=M.calculateDistance(c,l,u,p);if(o-h<0)break;o-=h,r++}if(r===a)return{lat:t[r].lat,long:t[r].long};var m=t[r],d=t[r+1],v=M.computeBearings(d.lat,d.long,m.lat,m.long);return M.calculateDestinationPoint(m.lat,m.long,v,o)}function R(t,e){for(var a=0,n=0,o=0,r=1/0;a<e.length;){var i=e[a],s=M.calculateDistance(t.lat,t.long,i.lat,i.long);s<r?(r=s,n=a,o=a):s==r&&(o=a),a++}return{minIndex:n,maxIndex:o}}function T(t,e,a){var n=function(t,e){for(var a=0,n=t.length;a<=n;){var o=Math.floor((a+n)/2),r=o+1,i=t[o],s=t[r];if(i.time<=e&&e<=s.time)return[o,r];e<i.time?n=o-1:a=o+1}throw new Error("Cannot find boundary between two stops!")}(t,a),o=t[n[0]],r=t[n[1]];return j(e,R(o,e).minIndex,R(r,e).maxIndex,(a-o.time)/(r.time-o.time))}var k=function(t){function e(t){var a;return Object(p.a)(this,e),(a=Object(m.a)(this,Object(d.a)(e).call(this,t))).createStopsLayer=function(){var t=new I.b({image:new S.a({radius:5,fill:null,stroke:new O.a({color:"red",width:1})})});return new b.a({source:new E.a,style:function(e){return t}})},a.updateStopsLayer=function(t){var e={type:"FeatureCollection",crs:{type:"name",properties:{name:"EPSG:3857"}},features:t.map(function(t){return{type:"Feature",geometry:{type:"Point",coordinates:Object(g.c)([t.long,t.lat])}}})};if(a.olStopsLayer){var n=a.olStopsLayer.getSource();n&&(n.clear(),n.addFeatures((new N.a).readFeatures(e)),n.refresh())}},a.createPathLayer=function(){var t=new I.b({stroke:new O.a({color:"green",width:3})});return new b.a({source:new E.a,style:function(e){return t}})},a.updatePathLayer=function(t){var e={type:"Feature",geometry:{type:"LineString",coordinates:t.map(function(t){return Object(g.c)([t.long,t.lat])})}};if(a.olPathLayer){var n=a.olPathLayer.getSource();n&&(n.clear(),n.addFeature((new N.a).readFeature(e)),n.refresh())}},a.createLiveLocationLayer=function(){var t=new I.b({image:new S.a({radius:10,fill:null,stroke:new O.a({color:"blue",width:2})})});return new b.a({source:new E.a,style:function(e){return t}})},a.updateLiveLocationLayer=function(t,e){var n={type:"Feature",geometry:{type:"Point",coordinates:Object(g.c)([e,t])}};if(a.olLiveLocationLayer){var o=a.olLiveLocationLayer.getSource();o&&(o.clear(),o.addFeature((new N.a).readFeature(n)),o.refresh())}},a.olMap=null,a.olPathLayer=null,a.olStopsLayer=null,a}return Object(v.a)(e,t),Object(h.a)(e,[{key:"componentDidMount",value:function(){var t=this.props.viewLocation.latitude,e=this.props.viewLocation.longitude,a=this.props.zoom;this.olView=new y.a({center:Object(g.c)([e,t]),zoom:a}),console.log("initialLatitude: "+t+" | initialLongitude: "+e),this.olPathLayer=this.createPathLayer(),this.olStopsLayer=this.createStopsLayer(),this.olLiveLocationLayer=this.createLiveLocationLayer(),this.olMap=new w.a({target:"map",layers:[new D.a({source:new L.a}),this.olPathLayer,this.olStopsLayer,this.olLiveLocationLayer],loadTilesWhileAnimating:!0,view:this.olView})}},{key:"shouldComponentUpdate",value:function(t,e){if(null!==this.olMap){this.updateDimensions();var a={};if(this.props.viewLocation!==t.viewLocation){var n=t.viewLocation.latitude,o=t.viewLocation.longitude;a.center=Object(g.c)([o,n]),a.duration=2e3,console.log("initialLatitude: "+n+" | initialLongitude: "+o)}this.props.zoom!==t.zoom&&(a.zoom=t.zoom,a.duration=2e3),a!=={}&&this.olView.animate(a),this.updatePathLayer(t.path),this.updateStopsLayer(t.stops);var r=t.currentLocation.latitude,i=t.currentLocation.longitude;this.updateLiveLocationLayer(r,i)}return!0}},{key:"updateDimensions",value:function(){var t=this;setTimeout(function(){t.olMap.updateSize()},200)}},{key:"render",value:function(){return o.a.createElement("div",{id:"map",className:"map"})}}]),e}(o.a.Component);function A(t){var e=Math.trunc(t/3600);t%=3600;var a=Math.trunc(t/60);t%=60;var n="",o="hours";return e>=1?1===e&&0===a?(n="1",o="hour"):(n=e+":"+Math.trunc(a).toString().padStart(2,"0"),o="hours"):a>=1?1===a&&0===t?(n="1",o="minute"):(n=a+":"+Math.trunc(t).toString().padStart(2,"0"),o="minutes"):1===t?(n="1",o="second"):(n=t.toString(),o="seconds"),{value:n,unit:o}}function W(t){var e=t.getHours(),a=t.getMinutes();return t.getSeconds()+60*a+3600*e}a(141);function P(){return new Date}var C=function(t){function e(){var t,a;Object(p.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(m.a)(this,(t=Object(d.a)(e)).call.apply(t,[this].concat(o)))).state={stops:[]},a}return Object(v.a)(e,t),Object(h.a)(e,[{key:"componentDidMount",value:function(){var t=this,e=-1;this.timer=setInterval(function(){var a=W(P());if(a>e){var n=t.props.stops.filter(function(t){return t.time>a}).map(function(t){return Object(u.a)({},t,{remainingTimeInSeconds:t.time-a})});t.setState(function(t,e){return Object(u.a)({},t,{stops:n})}),e=a}})}},{key:"componentWillUnmount",value:function(){clearInterval(this.timer)}},{key:"render",value:function(){var t=this,e=this.state.stops.map(function(e){var a=A(e.remainingTimeInSeconds),n="stop-interaction-button";return void 0!==t.props.alarms[e.ID]&&(n+=" stop-interaction-button-selected"),o.a.createElement("div",{key:e.ID,className:"stop-container"},o.a.createElement("div",{className:"stop-info-container"},o.a.createElement("div",{className:"stop-name"},e.name),o.a.createElement("div",{className:"remaining-time"},o.a.createElement("div",{className:"remaining-time-value"},a.value),o.a.createElement("div",{className:"remaining-time-unit"},a.unit))),o.a.createElement("div",{className:"stop-interactions-container"},o.a.createElement("div",{className:"stop-interactions"},o.a.createElement("div",{className:n,onClick:function(a){void 0===t.props.alarms[e.ID]?t.props.addNewAlarmHandler(e.ID):t.props.removeAlarmHandler(e.ID)}},"Notify me"))))});return o.a.createElement("div",null,o.a.createElement("div",{className:"trip-header-details-container"},o.a.createElement("div",{className:"trip-header-details"},o.a.createElement("h3",{className:"short-name"},this.props.tripShortName),o.a.createElement("p",{className:"long-name"},this.props.tripLongName))),o.a.createElement("div",{className:"stop-containers-list"},e))}}]),e}(o.a.Component),x=(a(143),function(t){function e(){var t,a;Object(p.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(m.a)(this,(t=Object(d.a)(e)).call.apply(t,[this].concat(o)))).handleSubmit=function(t){t.preventDefault(),console.log("Hi there!"),console.log(t.target.route.value);var e=t.target.route.value;console.log("I am here!"),""===e||a.props.onSelectRoute(e)},a}return Object(v.a)(e,t),Object(h.a)(e,[{key:"render",value:function(){var t=this.props.routes.length>0,e=this.props.routes.map(function(t,e){var a=t.shortName,n=t.longName,o=t.headsign,r="";return a&&(r+=a+" "),o&&(r+=o+" "),n&&(r+="("+n+")"),r.trim(),Object(u.a)({},t,{display:r})}).sort(function(t,e){return t.display<e.display}).filter(function(t){return t.startTime<=P()<=t.endTime}).map(function(t){var e=t.tripID,a=t.display;return o.a.createElement("div",{key:e},o.a.createElement("input",{type:"radio",name:"route",value:e}),o.a.createElement("div",{className:"tripInfo"},a))});return o.a.createElement("div",{className:"popup-background"},o.a.createElement("div",{className:"popup-container"},o.a.createElement("div",{className:"popup"},o.a.createElement("div",{className:"popup-header"},t?o.a.createElement("div",null,o.a.createElement("h3",null,"Which bus / train are you on?"),o.a.createElement("p",null,"There are multiple bus / train routes near your area. Please select which route you are currently on.")):o.a.createElement("div",null,o.a.createElement("h3",null,"There are no busses / trains near you!"),o.a.createElement("p",null,"Are you on a bus / train? If not, this explains why we cannot find your bus / train!"))),o.a.createElement("form",{onSubmit:this.handleSubmit},o.a.createElement("div",{className:"popup-contents"},t?e:o.a.createElement("p",null,"Please wait while we try to determine the busses / trains around you.")),o.a.createElement("div",{className:"popup-actions-container"},t?o.a.createElement("button",{className:"popup-action-button",type:"submit"},"OK"):null)))))}}]),e}(o.a.Component)),F=a(75),H=a.n(F);H.a.defaults.timeout=18e4;var V=function(){function t(){Object(p.a)(this,t)}return Object(h.a)(t,[{key:"getNearbyTrips",value:function(){var t=Object(l.a)(c.a.mark(function t(e,a,n,o){var r,i;return c.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,r={params:{lat:e,long:a,time:n,radius:o}},t.next=5,H.a.get("https://on-transit-app-api-gateway.herokuapp.com/api/v1/trips",r);case 5:return i=t.sent,console.log(i),t.abrupt("return",i.data.data);case 10:throw t.prev=10,t.t0=t.catch(0),t.t0;case 13:case"end":return t.stop()}},t,this,[[0,10]])}));return function(e,a,n,o){return t.apply(this,arguments)}}()},{key:"getTripDetails",value:function(){var t=Object(l.a)(c.a.mark(function t(e){var a,n;return c.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,a="https://on-transit-app-api-gateway.herokuapp.com/api/v1/trips/"+e,t.next=4,H.a.get(a);case 4:return n=t.sent,t.abrupt("return",n.data.data);case 8:throw t.prev=8,t.t0=t.catch(0),t.t0;case 11:case"end":return t.stop()}},t,this,[[0,8]])}));return function(e){return t.apply(this,arguments)}}()},{key:"getNearbyVehicles",value:function(){var t=Object(l.a)(c.a.mark(function t(e,a,n){var o,r;return c.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,o={params:{lat:e,long:a,radius:n}},t.next=5,H.a.get("https://on-transit-app-api-gateway.herokuapp.com/api/v1/vehicles",o);case 5:return r=t.sent,t.abrupt("return",r.data.data);case 9:throw t.prev=9,t.t0=t.catch(0),t.t0;case 12:case"end":return t.stop()}},t,this,[[0,9]])}));return function(e,a,n){return t.apply(this,arguments)}}()}]),t}(),z=(a(164),function(t){function e(){var t,a;Object(p.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(m.a)(this,(t=Object(d.a)(e)).call.apply(t,[this].concat(o)))).state={countdownValue:5},a}return Object(v.a)(e,t),Object(h.a)(e,[{key:"componentDidMount",value:function(){var t=this;this.countdownInterval=setInterval(function(){t.state.countdownValue<=0?t.props.restartApp():t.setState(function(t,e){return{countdownValue:t.countdownValue-1}})},1e3)}},{key:"componentWillUnmount",value:function(){this.countdownInterval&&clearInterval(this.countdownInterval)}},{key:"render",value:function(){return o.a.createElement("div",{className:"popup-background"},o.a.createElement("div",{className:"popup-container"},o.a.createElement("div",{className:"popup"},o.a.createElement("div",{className:"popup-header"},o.a.createElement("h3",null,"Which bus / train are you on?")),o.a.createElement("form",{onSubmit:this.handleSubmit},o.a.createElement("div",{className:"popup-contents"},o.a.createElement("p",null,"The bus or train has completed its trip! You will need to select a different trip."),o.a.createElement("p",null,"You will be redirected in ",o.a.createElement("span",null,this.state.countdownValue," seconds"),".")),o.a.createElement("div",{className:"popup-actions-container"})))))}}]),e}(o.a.Component)),G=function(t){function e(){var t,a;Object(p.a)(this,e);for(var n=arguments.length,o=new Array(n),r=0;r<n;r++)o[r]=arguments[r];return(a=Object(m.a)(this,(t=Object(d.a)(e)).call.apply(t,[this].concat(o)))).state={displayRouteChoices:!1,displayRouteDetails:!1,displayEndOfRouteMessage:!1,mapZoom:3,curLocation:{latitude:43.554028,longitude:-79.722099},initLocation:{latitude:0,longitude:0},possibleRoutes:[],tripDetailsID:null,tripDetails:{shortName:null,longName:null,path:[],stops:[]},alarms:{}},a.restartApp=function(){a.componentWillUnmount(),a.setState(function(t,e){return{displayRouteChoices:!1,displayRouteDetails:!1,displayEndOfRouteMessage:!1,mapZoom:3,curLocation:{latitude:43.554028,longitude:-79.722099},initLocation:{latitude:0,longitude:0},possibleRoutes:[],tripDetailsID:null,tripDetails:{shortName:null,longName:null,path:[],stops:[]},alarms:{}}}),a.componentDidMount()},a.startGeolocationWatch=function(){var t={enableHighAccuracy:!0,timeout:1/0,maximumAge:0};navigator.geolocation&&(a.geolocationWatch=navigator.geolocation.watchPosition(a.onLocationChangedSuccess,a.onLocationChangedError,t))},a.startPredictedLocationWatch=function(){a.state.tripDetails.stops.length>1&&(a.liveLocationWatch=setInterval(function(){var t=a.state.tripDetails.stops,e=a.state.tripDetails.path,n=W(P());if(n>=t[t.length-1].time)a.setState(function(t,e){return Object(u.a)({},t,{displayEndOfRouteMessage:!0,displayRouteDetails:!1})});else{var o=T(t,e,n);a.setState(function(t,e){return Object(u.a)({},t,{curLocation:{latitude:o.lat,longitude:o.long}})})}}))},a.startAlarmWatch=function(){a.alarmInterval=setInterval(function(){var t=W(P());Object.keys(a.state.alarms).forEach(function(e){var n=a.state.tripDetails.stops.find(function(t){return t.ID==e});if(void 0===n)throw new Error("Inconsistency with stop ID "+e+" and trip details!");var o=a.state.alarms[e];n.time-t<o.minRemainingTimeLeft&&!o.isDispatched&&(console.log("RING RING RING!!!"),a.dispatchAlarm(n),a.removeAlarm(e))})})},a.stopAlarmWatch=function(){a.alarmInterval&&clearInterval(a.alarmInterval)},a.stopLiveLocationWatch=function(){a.liveLocationWatch&&clearInterval(a.liveLocationWatch)},a.stopGeolocationWatch=function(){navigator.geolocation.clearWatch(a.geolocationWatch)},a.onLocationChangedSuccess=function(t){var e=t.coords.latitude,n=t.coords.longitude,o=t.coords.accuracy,r=(new Date).toLocaleTimeString();if(console.log(a.state),null===a.state.tripDetailsID){console.log("heee");var i=a.onTransitService.getNearbyTrips(e,n,r,o),s=a.onTransitService.getNearbyVehicles(e,n,o);Promise.all([i,s]).then(function(t){if(null===a.state.tripDetailsID){console.log(Object.keys(t[0].tripIDs));var o=Object.keys(t[0].tripIDs).map(function(e){var a=e,n=t[0].tripIDs[a];return Object(u.a)({},n,{tripID:a})});console.log(o),a.setState(function(t,a){return Object(u.a)({},t,{displayRouteChoices:!0,possibleRoutes:o,curLocation:{latitude:e,longitude:n}})})}}).catch(function(t){console.log(t)})}},a.onLocationChangedError=function(t){console.log("ERROR!"),console.log(t)},a.selectRoute=function(t){console.log("Selected Trip ID: "+t),a.state.tripDetailsID!==t&&a.onTransitService.getTripDetails(t).then(function(e){e.stops=e.stops.map(function(t,e){return Object(u.a)({},t,{ID:e})});var n=e.path.reduce(function(t,e){return t+e.lat},0),o=e.path.reduce(function(t,e){return t+e.long},0),r=n/e.path.length,i=o/e.path.length;a.setState(function(a,n){return Object(u.a)({},a,{initLocation:{latitude:r,longitude:i},tripDetailsID:t,displayRouteDetails:!0,displayRouteChoices:!1,tripDetails:e,mapZoom:13,alarms:{}})},function(){a.startPredictedLocationWatch()})}).catch(function(t){console.log(t)})},a.addNewAlarm=function(t){if(!a.state.tripDetails.stops[t.toString()])throw new Error("Inconsistencies with stopID "+t+" and this.state.tripDetails.stops");a.setState(function(e,n){var o=e.alarms;o[t]={minRemainingTimeLeft:300,isDispatched:!1};var r="You will be notified 5 minutes before reaching "+a.state.tripDetails.stops[t.toString()].name;return Object(f.toast)(r,{position:f.toast.POSITION.BOTTOM_CENTER}),console.log(r),Object(u.a)({},e,{alarms:o})})},a.removeAlarm=function(t){a.setState(function(e,n){delete e.alarms[t.toString()];var o="Removed notification for stop "+a.state.tripDetails.stops[t.toString()].name;return Object(f.toast)(o,{position:f.toast.POSITION.BOTTOM_CENTER}),console.log(o),e}),console.log("Removed alarm "+t)},a.dispatchNotification=function(t,e){Notification.requestPermission().then(function(t){if("granted"!==t)throw new Error("No access!")}).then(function(){console.log("We have access here!");var a=new Notification(t);setTimeout(function(){a.close()},e)}).catch(function(t){console.log("We have no access here!")})},a.dispatchAlarm=function(t){var e=W(P()),n=A(t.time-e),o=t.ID,r="You are "+n.value+" "+n.unit+" away from "+t.name;a.dispatchNotification(r,1e4),a.setState(function(t,e){var a=t.alarms;return a[o.toString()].isDispatched=!0,Object(u.a)({},t,{alarms:a})})},a}return Object(v.a)(e,t),Object(h.a)(e,[{key:"componentDidMount",value:function(){var t=Object(l.a)(c.a.mark(function t(){return c.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:this.onTransitService=new V,"Notification"in window||alert("Notifications are not supported in this browser!"),Notification.requestPermission(),this.startGeolocationWatch(),this.startAlarmWatch();case 5:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"componentWillUnmount",value:function(){this.stopAlarmWatch(),this.stopLiveLocationWatch(),this.stopGeolocationWatch()}},{key:"render",value:function(){return o.a.createElement("div",{className:"app-container"},this.state.displayRouteDetails?o.a.createElement("div",{className:"left-panel"},o.a.createElement(C,{tripShortName:this.state.tripDetails.shortName,tripLongName:this.state.tripDetails.longName,stops:this.state.tripDetails.stops,alarms:this.state.alarms,addNewAlarmHandler:this.addNewAlarm,removeAlarmHandler:this.removeAlarm})):null,o.a.createElement("div",{className:"right-panel"},o.a.createElement(k,{viewLocation:this.state.initLocation,zoom:this.state.mapZoom,currentLocation:this.state.curLocation,path:this.state.tripDetails.path,stops:this.state.tripDetails.stops})),this.state.displayRouteChoices?o.a.createElement(x,{routes:this.state.possibleRoutes,onSelectRoute:this.selectRoute}):null,this.state.displayEndOfRouteMessage?o.a.createElement(z,{restartApp:this.restartApp}):null,o.a.createElement(f.ToastContainer,null))}}]),e}(o.a.Component);i.a.render(o.a.createElement(G,null),document.getElementById("root"))}},[[112,2,1]]]);
//# sourceMappingURL=main.18ca3a6b.chunk.js.map